<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Agent - Occupation</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <header class="app-header">
      <div class="agent-header">
        <button id="backBtn" class="btn secondary" type="button">‚Üê Back</button>
        <div class="icon" id="headerIcon" style="background-color: #3b82f6">üíº</div>
        <h1 class="app-title" id="headerTitle">Occupation</h1>
      </div>
      <div class="header-actions">
        <select id="themeSelect" class="theme-selector">
          <option value="dark">Dark Mode</option>
          <option value="aol">AOL Instant Messenger</option>
        </select>
      </div>
    </header>

    <main class="agent-container">
      <section class="chat-section">
        <div class="chat-header">
          <h3>AI Agent Chat</h3>
          <div class="chat-controls">
            <button id="testAgentBtn" class="btn secondary">Test Connection</button>
            <button id="clearChatBtn" class="btn ghost">Clear Chat</button>
          </div>
        </div>
        <div id="chatContainer" class="chat-container">
          <div id="chatMessages" class="chat-messages">
            <div class="message bot-message">
              <div class="message-avatar">ü§ñ</div>
              <div class="message-content">
                <div class="message-text">
                  <strong>AI Assistant:</strong> Hello! I'm your specialized <span id="agentTitle">AI agent</span>. 
                  <span id="connectionStatus">Ready to chat! I'm connected to OpenAI GPT-4.</span>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-input-container">
            <textarea id="chatInput" class="chat-input" placeholder="Ask me anything about this field..." rows="2"></textarea>
            <button id="sendBtn" class="btn primary">Send</button>
          </div>
        </div>
        <div class="chat-status">
          <div class="status-indicator">
            <div class="status-dot"></div>
            <span>Connected to OpenAI GPT-4</span>
          </div>
        </div>
      </section>
      
      <section class="notes-section">
        <div class="notes-header">
          <h3>Notes</h3>
          <button id="addNoteBtn" class="btn primary">+ Add Note</button>
        </div>
        <div id="notesContainer" class="notes-container">
          <!-- Notes will be dynamically added here -->
        </div>
      </section>
    </main>

    <script src="config.js"></script>
    <script>
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Get occupation data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const occupation = {
          id: urlParams.get('id'),
          title: urlParams.get('title'),
          emoji: urlParams.get('emoji'),
          color: urlParams.get('color'),
          instructions: urlParams.get('instructions') || ''
        };

        // DOM elements
        const headerIcon = document.getElementById('headerIcon');
        const headerTitle = document.getElementById('headerTitle');
        const agentTitle = document.getElementById('agentTitle');
        const backBtn = document.getElementById('backBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const testAgentBtn = document.getElementById('testAgentBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const themeSelect = document.getElementById('themeSelect');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const notesContainer = document.getElementById('notesContainer');

        // Theme management
        function loadTheme() {
          const savedTheme = localStorage.getItem('dashboard-theme') || 'dark';
          setTheme(savedTheme);
          if (themeSelect) {
            themeSelect.value = savedTheme;
          }
        }

        function setTheme(theme) {
          document.documentElement.setAttribute('data-theme', theme);
          localStorage.setItem('dashboard-theme', theme);
        }

        function switchTheme(theme) {
          setTheme(theme);
        }

        // Initialize page
        function init() {
          if (!occupation.id) {
            window.location.href = 'index.html';
            return;
          }

          // Load theme first
          loadTheme();

          // Update page title
          document.title = `AI Agent - ${occupation.title}`;

          // Update page content
          headerTitle.textContent = occupation.title;
          agentTitle.textContent = occupation.title;
          headerIcon.textContent = occupation.emoji;
          headerIcon.style.backgroundColor = occupation.color;
          
          // Always show test button since we're using OpenAI API
          testAgentBtn.hidden = false;
          connectionStatus.textContent = "Ready to chat! I'm connected to OpenAI GPT-4.";

          // Load chat history and notes
          loadChatHistory();
          loadNotes();

          // Setup event listeners
          backBtn.onclick = () => window.location.href = 'index.html';
          clearChatBtn.onclick = clearChatHistory;
          addNoteBtn.onclick = createNewNote;
          sendBtn.onclick = sendMessage;
          chatInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          };
          testAgentBtn.onclick = testAgentConnection;
          
          // Theme switcher
          if (themeSelect) {
            themeSelect.onchange = (e) => switchTheme(e.target.value);
          }
        }


        // Load chat history from localStorage
        function loadChatHistory() {
          const chatHistory = localStorage.getItem(`occupation-chat-${occupation.id}`);
          if (chatHistory) {
            const messages = JSON.parse(chatHistory);
            // Clear the default welcome message
            chatMessages.innerHTML = '';
            // Load all saved messages
            messages.forEach(msg => {
              addMessage(msg.content, msg.sender, false); // false = don't save to history
            });
          }
        }

        // Save chat history to localStorage
        function saveChatHistory() {
          const messages = [];
          const messageElements = chatMessages.querySelectorAll('.message:not(.typing-indicator)');
          messageElements.forEach(msgEl => {
            const textEl = msgEl.querySelector('.message-text');
            const content = textEl ? textEl.textContent : msgEl.querySelector('.message-content').textContent;
            const sender = msgEl.classList.contains('user-message') ? 'user' : 'bot';
            messages.push({ content, sender });
          });
          localStorage.setItem(`occupation-chat-${occupation.id}`, JSON.stringify(messages));
        }


        // Clear chat history
        function clearChatHistory() {
          if (confirm('Clear all chat history for this occupation?')) {
            chatMessages.innerHTML = `
              <div class="message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                  <div class="message-text">
                    <strong>AI Assistant:</strong> Hello! I'm your specialized <span id="agentTitle">AI agent</span>. 
                    <span id="connectionStatus">Ready to chat! I'm connected to OpenAI GPT-4.</span>
                  </div>
                </div>
              </div>
            `;
            localStorage.removeItem(`occupation-chat-${occupation.id}`);
          }
        }

        // Chat functionality
        function sendMessage() {
          const message = chatInput.value.trim();
          if (!message) return;

          // Add user message to chat and save to history immediately
          addMessage(message, 'user');
          chatInput.value = '';

          // Show typing indicator
          showTypingIndicator();

          // Get AI response from OpenAI
          getAIResponse(message, occupation)
            .then(response => {
              hideTypingIndicator();
              addMessage(response, 'bot');
            })
            .catch(error => {
              hideTypingIndicator();
              let errorMessage = "Sorry, I'm having trouble connecting to the AI service.";
              
              if (error.message === 'CORS_ERROR') {
                errorMessage = "‚ùå CORS Error: The AI service doesn't allow requests from this website. Try using a CORS proxy or a service that supports direct API access.";
                corsHelp.hidden = false;
              } else if (error.message === 'NETWORK_ERROR') {
                errorMessage = "‚ùå Network Error: Unable to reach the AI service. Please check your internet connection.";
              } else if (error.message.includes('HTTP error')) {
                errorMessage = `‚ùå Server Error: ${error.message}. The AI service may be down or there may be an authentication issue.`;
              }
              
              addMessage(errorMessage, 'bot');
              console.error('AI response error:', error);
            });
        }

        function addMessage(content, sender, saveToHistory = true) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${sender}-message`;
          
          // Add avatar
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'message-avatar';
          avatarDiv.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          
          const textDiv = document.createElement('div');
          textDiv.className = 'message-text';
          textDiv.innerHTML = formatMessage(content);
          
          contentDiv.appendChild(textDiv);
          messageDiv.appendChild(avatarDiv);
          messageDiv.appendChild(contentDiv);
          chatMessages.appendChild(messageDiv);
          
          // Scroll to bottom
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // Save to chat history if requested
          if (saveToHistory) {
            saveChatHistory();
          }
        }

        // Simple formatting function for better text display
        function formatMessage(text) {
          return text
            .replace(/\n/g, '<br>') // Convert line breaks to HTML
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
            .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic text
            .replace(/`(.*?)`/g, '<code>$1</code>') // Inline code
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>'); // Code blocks
        }

        function showTypingIndicator() {
          const typingDiv = document.createElement('div');
          typingDiv.className = 'message bot-message typing-indicator';
          typingDiv.id = 'typing-indicator';
          
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'message-avatar';
          avatarDiv.textContent = 'ü§ñ';
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          
          const textDiv = document.createElement('div');
          textDiv.className = 'message-text';
          textDiv.innerHTML = `
            <span>AI Assistant is typing</span>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          `;
          
          contentDiv.appendChild(textDiv);
          typingDiv.appendChild(avatarDiv);
          typingDiv.appendChild(contentDiv);
          chatMessages.appendChild(typingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
          const typingIndicator = document.getElementById('typing-indicator');
          if (typingIndicator) {
            typingIndicator.remove();
          }
        }

        async function getAIResponse(userMessage, occupation) {
          // Build conversation history
          const messages = [];
          
          // Add system prompt with custom instructions
          const systemPrompt = occupation.instructions || `You are a specialized AI assistant for ${occupation.title}. Provide helpful, professional advice related to this field.`;
          const fullSystemPrompt = `${systemPrompt}

IMPORTANT: You have access to our conversation history. You can see and reference previous questions and answers in this chat. When asked about previous interactions, you should be able to recall and reference them. Always acknowledge when you're referencing something from our previous conversation.`;
          messages.push({ role: "system", content: fullSystemPrompt });
          
          // Add chat history (last 20 messages to maintain better context)
          const chatHistory = localStorage.getItem(`occupation-chat-${occupation.id}`);
          if (chatHistory) {
            const historyMessages = JSON.parse(chatHistory);
            // Take last 20 messages to maintain better context
            const recentHistory = historyMessages.slice(-20);
            recentHistory.forEach(msg => {
              messages.push({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.content });
            });
            console.log(`Loaded ${recentHistory.length} messages from chat history for context`);
          } else {
            console.log('No chat history found');
          }
          
          // Add current user message
          messages.push({ role: "user", content: userMessage });

          const payload = {
            model: "gpt-4o",
            messages: messages
          };

          // Debug: Log the messages being sent to OpenAI
          console.log('Sending messages to OpenAI:', messages);

          try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${window.CONFIG.OPENAI_API_KEY}`
              },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            
            // Extract the AI response from OpenAI's format
            if (data.choices && data.choices[0] && data.choices[0].message) {
              return data.choices[0].message.content;
            } else {
              throw new Error('Unexpected response format from OpenAI API');
            }
          } catch (error) {
            // Handle CORS and other network errors
            if (error.name === 'TypeError' && error.message.includes('CORS')) {
              throw new Error('CORS_ERROR');
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
              throw new Error('NETWORK_ERROR');
            } else {
              throw error;
            }
          }
        }

        function testAgentConnection() {
          testAgentBtn.textContent = 'Testing...';
          testAgentBtn.disabled = true;
          
          // Test the OpenAI API with a simple request
          const testPayload = {
            model: "gpt-4o",
            messages: [
              { role: "system", content: "You are a helpful assistant." },
              { role: "user", content: "Hello, this is a connection test." }
            ],
            max_tokens: 10
          };

          fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${window.CONFIG.OPENAI_API_KEY}`
            },
            body: JSON.stringify(testPayload)
          }).then(response => {
            if (response.ok) {
              testAgentBtn.textContent = 'Connection OK';
              testAgentBtn.style.background = '#10b981';
            } else {
              testAgentBtn.textContent = 'Connection Failed';
              testAgentBtn.style.background = '#ef4444';
            }
            setTimeout(() => {
              testAgentBtn.textContent = 'Test Connection';
              testAgentBtn.style.background = '';
              testAgentBtn.disabled = false;
            }, 2000);
          }).catch(() => {
            testAgentBtn.textContent = 'Connection Failed';
            testAgentBtn.style.background = '#ef4444';
            setTimeout(() => {
              testAgentBtn.textContent = 'Test Connection';
              testAgentBtn.style.background = '';
              testAgentBtn.disabled = false;
            }, 2000);
          });
        }

        // Notes functionality
        function loadNotes() {
          let notes = [];
          try {
            const stored = localStorage.getItem(`occupation-notes-${occupation.id}`);
            if (stored) {
              // Try to parse as JSON first
              notes = JSON.parse(stored);
            }
          } catch (error) {
            // If parsing fails, it might be old plain text format
            console.log('Converting old notes format to new format');
            const oldText = localStorage.getItem(`occupation-notes-${occupation.id}`);
            if (oldText && oldText.trim()) {
              // Convert old single note to new format
              notes = [{
                id: Date.now().toString(),
                title: 'Migrated Note',
                content: oldText,
                color: '#ffffff'
              }];
            }
          }
          
          notesContainer.innerHTML = '';
          notes.forEach(note => {
            createNoteElement(note);
          });
        }

        function saveNotes() {
          const notes = [];
          const noteElements = notesContainer.querySelectorAll('.note');
          noteElements.forEach(noteEl => {
            const id = noteEl.dataset.noteId;
            const title = noteEl.querySelector('.note-title').textContent;
            const content = noteEl.querySelector('.note-content').textContent;
            const color = noteEl.dataset.color || '#ffffff';
            notes.push({ id, title, content, color });
          });
          localStorage.setItem(`occupation-notes-${occupation.id}`, JSON.stringify(notes));
        }

        function createNewNote() {
          const note = {
            id: Date.now().toString(),
            title: 'New Note',
            content: 'Click to edit...',
            color: '#ffffff'
          };
          console.log('Creating new note:', note);
          createNoteElement(note);
          saveNotes();
        }

        function createNoteElement(note) {
          console.log('Creating note element for:', note);
          const noteEl = document.createElement('div');
          noteEl.className = 'note';
          noteEl.dataset.noteId = note.id;
          noteEl.dataset.color = note.color;
          noteEl.style.backgroundColor = note.color;
          noteEl.draggable = true;
          
          noteEl.innerHTML = `
            <div class="note-header">
              <div class="note-title" contenteditable="true">${note.title}</div>
              <div class="note-actions">
                <button class="note-color-btn" title="Change color">üé®</button>
                <button class="note-delete-btn" title="Delete note">üóëÔ∏è</button>
              </div>
            </div>
            <div class="note-content" contenteditable="true">${note.content}</div>
          `;
          
          // Add event listeners
          const titleEl = noteEl.querySelector('.note-title');
          const contentEl = noteEl.querySelector('.note-content');
          const colorBtn = noteEl.querySelector('.note-color-btn');
          const deleteBtn = noteEl.querySelector('.note-delete-btn');
          
          titleEl.onblur = saveNotes;
          contentEl.onblur = saveNotes;
          
          colorBtn.onclick = () => changeNoteColor(noteEl);
          deleteBtn.onclick = () => deleteNote(noteEl);
          
          // Drag and drop event listeners
          noteEl.ondragstart = (e) => handleDragStart(e, noteEl);
          noteEl.ondragover = (e) => handleDragOver(e);
          noteEl.ondrop = (e) => handleDrop(e, noteEl);
          noteEl.ondragend = (e) => handleDragEnd(e, noteEl);
          
          notesContainer.appendChild(noteEl);
        }

        function changeNoteColor(noteEl) {
          const colors = ['#ffffff', '#f28b82', '#fbbc04', '#fff475', '#ccff90', '#a7ffeb', '#cbf0f8', '#aecbfa', '#d7aefb', '#fdcfe8'];
          const currentColor = noteEl.dataset.color;
          const currentIndex = colors.indexOf(currentColor);
          const nextIndex = (currentIndex + 1) % colors.length;
          const newColor = colors[nextIndex];
          
          noteEl.dataset.color = newColor;
          noteEl.style.backgroundColor = newColor;
          saveNotes();
        }

        function deleteNote(noteEl) {
          if (confirm('Delete this note?')) {
            noteEl.remove();
            saveNotes();
          }
        }

        // Drag and drop functionality
        let draggedElement = null;

        function handleDragStart(e, noteEl) {
          draggedElement = noteEl;
          noteEl.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', noteEl.outerHTML);
        }

        function handleDragOver(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          
          const afterElement = getDragAfterElement(notesContainer, e.clientY);
          const dragging = document.querySelector('.dragging');
          
          if (afterElement == null) {
            notesContainer.appendChild(dragging);
          } else {
            notesContainer.insertBefore(dragging, afterElement);
          }
        }

        function handleDrop(e, noteEl) {
          e.preventDefault();
          if (draggedElement && draggedElement !== noteEl) {
            const afterElement = getDragAfterElement(notesContainer, e.clientY);
            if (afterElement == null) {
              notesContainer.appendChild(draggedElement);
            } else {
              notesContainer.insertBefore(draggedElement, afterElement);
            }
            saveNotes();
          }
        }

        function handleDragEnd(e, noteEl) {
          noteEl.classList.remove('dragging');
          draggedElement = null;
        }

        function getDragAfterElement(container, y) {
          const draggableElements = [...container.querySelectorAll('.note:not(.dragging)')];
          
          return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Initialize the page
        init();
      });
    </script>
  </body>
</html>
